name: Daily Data Generator

on:
  schedule:
    # Production schedule: Runs at 12 AM PHT (UTC+8) = 16:00 UTC
    - cron: '0 16 * * *'
    # Testing schedule: Runs every 5 minutes
    #- cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  generate-data:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # Increased from 60 to 120 minutes
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.14'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r FMCG/requirements.txt
        
    - name: Authenticate to GCP
      run: |
        echo "${{ secrets.GCP_SERVICE_ACCOUNT }}" | base64 -d > $HOME/gcloud-key.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-key.json" >> $GITHUB_ENV
        
    - name: Check environment and configuration
      run: |
        echo "=== Environment Variables ==="
        echo "GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'fmcg-data-simulator' }}"
        echo "BQ_DATASET: ${{ secrets.BQ_DATASET || 'fmcg_analytics' }}"
        echo "INITIAL_SALES_AMOUNT: ${{ secrets.INITIAL_SALES_AMOUNT || '6000000000' }}"
        echo "DAILY_SALES_AMOUNT: ${{ secrets.DAILY_SALES_AMOUNT || '1644000' }}"
        echo "SCHEDULED_RUN: ${{ github.event_name == 'schedule' && 'true' || 'false' }}"
        echo "=== Python Version ==="
        python --version
        echo "=== Disk Space ==="
        df -h
        echo "=== Memory ==="
        free -h
        
    - name: Run data generator with enhanced logging
      env:
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'fmcg-data-simulator' }}
        BQ_DATASET: ${{ secrets.BQ_DATASET || 'fmcg_analytics' }}
        INITIAL_SALES_AMOUNT: ${{ secrets.INITIAL_SALES_AMOUNT || '6000000000' }}
        DAILY_SALES_AMOUNT: ${{ secrets.DAILY_SALES_AMOUNT || '1644000' }}
        GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
        SCHEDULED_RUN: ${{ github.event_name == 'schedule' && 'true' || 'false' }}
      run: |
        cd FMCG
        echo "=== Starting Data Generation ==="
        echo "Time: $(date)"
        echo "Working Directory: $(pwd)"
        
        # Set environment variables for debugging
        export PYTHONUNBUFFERED=1
        export GCP_SERVICE_ACCOUNT="${{ secrets.GCP_SERVICE_ACCOUNT }}"
        
        # Run with timeout and progress monitoring
        python main.py 2>&1 | tee /tmp/generator.log
        
        echo "=== Data Generation Completed ==="
        echo "Time: $(date)"
        echo "=== Log File Size ==="
        ls -lh /tmp/generator.log
        
    - name: Upload logs if failed
      if: failure()
      run: |
        echo "=== Uploading error logs ==="
        cat /tmp/generator.log
        
    - name: Cleanup
      if: always()
      run: |
        rm -f $HOME/gcloud-key.json
