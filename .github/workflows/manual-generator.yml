name: Manual Data Generator

on:
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh all tables (regenerate everything)'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      mode:
        description: 'Generation mode'
        required: false
        default: 'full'
        type: choice
        options:
        - 'full'
        - 'incremental'

jobs:
  generate-data:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    env:
      PYTHONUNBUFFERED: 1
      PYTHONHASHSEED: 0
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.14'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install psutil
        
    - name: Authenticate to GCP
      run: |
        echo "${{ secrets.GCP_SERVICE_ACCOUNT }}" | base64 -d > $HOME/gcloud-key.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-key.json" >> $GITHUB_ENV
        
    - name: Check environment and configuration
      run: |
        echo "=== Environment Variables ==="
        echo "GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'fmcg-data-generator' }}"
        echo "BQ_DATASET: ${{ secrets.BQ_DATASET || 'fmcg_warehouse' }}"
        echo "INITIAL_SALES_AMOUNT: ${{ secrets.INITIAL_SALES_AMOUNT || '8000000000' }}"
        echo "DAILY_SALES_AMOUNT: ${{ secrets.DAILY_SALES_AMOUNT || '2000000' }}"
        echo "FORCE_REFRESH: ${{ github.event.inputs.force_refresh || 'true' }}"
        echo "MODE: ${{ github.event.inputs.mode || 'full' }}"
        echo "=== Python Version ==="
        python --version
        echo "=== System Resources ==="
        echo "CPU cores: $(nproc)"
        echo "Memory: $(free -h | grep '^Mem:' | awk '{print $2}')"
        echo "Disk space: $(df -h / | tail -n 1 | awk '{print $4}')"
        
    - name: Run setup script
      env:
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'fmcg-data-generator' }}
        BQ_DATASET: ${{ secrets.BQ_DATASET || 'fmcg_warehouse' }}
        INITIAL_SALES_AMOUNT: ${{ secrets.INITIAL_SALES_AMOUNT || '8000000000' }}
        DAILY_SALES_AMOUNT: ${{ secrets.DAILY_SALES_AMOUNT || '2000000' }}
        GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      run: |
        echo "=== Running Setup Script ==="
        echo "Time: $(date)"
        
        # Run setup to verify configuration and create dataset
        python scripts/setup.py
        
        echo "=== Setup Completed ==="
        echo "Time: $(date)"
        
    - name: Run data generator with enhanced monitoring
      env:
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'fmcg-data-generator' }}
        BQ_DATASET: ${{ secrets.BQ_DATASET || 'fmcg_warehouse' }}
        INITIAL_SALES_AMOUNT: ${{ secrets.INITIAL_SALES_AMOUNT || '8000000000' }}
        DAILY_SALES_AMOUNT: ${{ secrets.DAILY_SALES_AMOUNT || '2000000' }}
        GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
        MODE: ${{ github.event.inputs.mode || 'full' }}
        FORCE_REFRESH: ${{ github.event.inputs.force_refresh || 'true' }}
      run: |
        echo "=== Starting Manual Data Generation ==="
        echo "Time: $(date)"
        echo "Working Directory: $(pwd)"
        echo "Available Memory: $(free -h | grep '^Mem:' | awk '{print $7}')"
        echo "MODE: $MODE"
        echo "FORCE_REFRESH: $FORCE_REFRESH"
        
        # Determine execution mode
        if [ "$MODE" = "incremental" ]; then
          echo "Running in incremental mode..."
          timeout 150m python src/main.py --incremental 2>&1 | tee /tmp/generator.log
        else
          echo "Running in full mode..."
          timeout 150m python src/main.py 2>&1 | tee /tmp/generator.log
        fi
        
        echo "=== Data Generation Completed ==="
        echo "Time: $(date)"
        echo "=== Log File Size ==="
        ls -lh /tmp/generator.log
        
    - name: Upload logs if failed
      if: failure()
      run: |
        echo "=== Uploading error logs ==="
        echo "Last 100 lines of generator log:"
        tail -100 /tmp/generator.log || echo "No log file found"
        
    - name: Cleanup
      if: always()
      run: |
        rm -f $HOME/gcloud-key.json
